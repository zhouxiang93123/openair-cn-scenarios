#!/bin/bash
################################################################################
# Licensed to the OpenAirInterface (OAI) Software Alliance under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The OpenAirInterface Software Alliance licenses this file to You under 
# the Apache License, Version 2.0  (the "License"); you may not use this file
# except in compliance with the License.  
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#-------------------------------------------------------------------------------
# For more information about the OpenAirInterface (OAI) Software Alliance:
#      contact@openairinterface.org
################################################################################
# file s1_prepare_test_scenario
# brief
# author Lionel Gauthier
# company Eurecom
# email: lionel.gauthier@eurecom.fr
# 

################################
# include helper functions
################################
THIS_SCRIPT_PATH=$(dirname $(readlink -f $0))
source $THIS_SCRIPT_PATH/script_helper

if [ -f "./enb.conf" ] && [ -f "./s1.pcapng" ] && [ -f "./hss_db.sql" ] && [ -f "./mme.conf" ] && [ -f "./spgw.conf" ] && [ -f "./mme_fd.conf" ]; then 
  # generate XML scenario file
  echo_success "Running build test in `pwd`"
  test_epc --build-test --test-dir . --old-enb-config-file enb.conf --pcap-file s1.pcapng
  
  # Fill new DB with updated values for testbed: mmeidentity (mme hostname/realm)
  if [ ! -f  "./hss_db.replay.sql" ]; then
    cp ./hss_db.sql ./hss_db.replay.sql
    DIAM_ID=$(cat ./mme_fd.conf | grep Identity | cut -d '=' -f2 | cut -d '"' -f2)
    DIAM_ID=$DIAM_ID
    HOST_FQDN=`hostname --fqdn`
    #HARDCODED EPC TEST DIAMETER ID
    sed -i "s/$DIAM_ID/$HOST_FQDN/g" ./hss_db.replay.sql
    
    REALM=$(cat ./mme_fd.conf | grep Realm | cut -d '=' -f2 | cut -d '"' -f2)
    REALM=$REALM
    #HARDCODED EPC REALM
    sed -i "s/$REALM/openair4G.eur/g" ./hss_db.replay.sql
  fi
fi
